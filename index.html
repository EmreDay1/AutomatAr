<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Automata AR</title>

  <!-- Same library references as your working index.html -->
  <script src="libs/Three.js"></script>
  <script src="libs/STLLoader.js"></script>
  <script src="src/svd.js"></script>
  <script src="src/posit1.js"></script>
  <script src="src/cv.js"></script>
  <script src="src/aruco.js"></script>
  <script src="src/atf.js"></script>
  <script src="src/multiS.js"></script>
  <script src="src/optic.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
      scroll-snap-type: y mandatory;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #FF8C00;
      color: #ffffff;
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* Enhanced Apple-style Animation Keyframes */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(80px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInLeft {
      from {
        opacity: 0;
        transform: translateX(-80px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes fadeInRight {
      from {
        opacity: 0;
        transform: translateX(80px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(40px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    @keyframes slideInFromBottom {
      from {
        opacity: 0;
        transform: translateY(100px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Scroll-triggered animations */
    .scroll-section {
      scroll-snap-align: start;
      min-height: 100vh;
      display: flex;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    .scroll-content.in-view {
      transform: translateY(0);
      opacity: 1;
    }

    .scroll-content {
      transform: translateY(60px);
      opacity: 0;
      transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* Override for intro section - always visible */
    .intro-section {
      opacity: 1 !important;
      transform: translateY(0) !important;
    }

    .intro-section * {
      opacity: 1 !important;
      color: #ffffff !important;
      transform: translateY(0) !important;
    }

    .intro-section .scroll-content {
      opacity: 1 !important;
      transform: translateY(0) !important;
    }

    .parallax-element {
      transition: transform 0.1s ease-out;
    }

    /* Progressive reveal animations */
    .progressive-reveal {
      overflow: hidden;
    }

    .progressive-reveal > * {
      transform: translateY(40px);
      opacity: 0;
      transition: all 0.6s ease-out;
    }

    .progressive-reveal.revealed > * {
      transform: translateY(0);
      opacity: 1;
    }

    .progressive-reveal.revealed > *:nth-child(1) { transition-delay: 0.1s; }
    .progressive-reveal.revealed > *:nth-child(2) { transition-delay: 0.2s; }
    .progressive-reveal.revealed > *:nth-child(3) { transition-delay: 0.3s; }
    .progressive-reveal.revealed > *:nth-child(4) { transition-delay: 0.4s; }

    /* Animation classes */
    .animate-on-scroll {
      opacity: 0;
      transition: all 0.6s ease-out;
    }

    .animate-on-scroll.animate {
      animation-duration: 0.8s;
      animation-fill-mode: both;
    }

    .fade-up.animate {
      animation-name: fadeInUp;
    }

    .fade-left.animate {
      animation-name: fadeInLeft;
    }

    .fade-right.animate {
      animation-name: fadeInRight;
    }

    .scale-in.animate {
      animation-name: scaleIn;
    }

    /* Header */
    .header-bar {
      background-color: #FF8C00;
      border-bottom: 1px solid #ffffff;
      padding: 1.5rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    .header-bar h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #ffffff;
      letter-spacing: 2px;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .header-buttons {
      position: static;
    }

    .header-ar-button {
      background: #ffffff;
      color: #FF8C00;
      border: 2px solid #ffffff;
      padding: 0.8rem 1.5rem;
      font-size: 0.9rem;
      font-weight: 700;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-ar-button:hover {
      background: #FF8C00;
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* Home Screen */
    #homeScreen {
      display: none;
      scroll-snap-type: y mandatory;
      overflow-y: auto;
      height: 100vh;
    }

    .intro-section {
      scroll-snap-align: start;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 4rem 2rem;
      position: relative;
    }

    .intro-section h2 {
      font-size: clamp(2.5rem, 5vw, 4rem);
      font-weight: 700;
      color: #ffffff !important;
      margin-bottom: 2rem;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      letter-spacing: -2px;
      opacity: 1 !important;
    }

    .intro-section p {
      font-size: clamp(1.1rem, 2.5vw, 1.4rem);
      color: #ffffff !important;
      max-width: 800px;
      margin: 0 auto 3rem auto;
      line-height: 1.8;
      opacity: 1 !important;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    /* Kit sections */
    .kit-section {
      scroll-snap-align: start;
      min-height: 100vh;
      display: flex;
      align-items: center;
      padding: 4rem 0;
      margin: 0;
      background-color: #FF7F00;
      border-radius: 0;
      box-shadow: none;
      border: none;
      transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
    }

    .kit-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, 
        rgba(255, 140, 0, 0.95) 0%, 
        rgba(255, 127, 0, 0.98) 50%, 
        rgba(255, 102, 0, 0.95) 100%);
      z-index: -1;
    }

    .kit-section:nth-child(odd) {
      background-color: #FF8C00;
    }

    .kit-section:nth-child(odd)::before {
      background: linear-gradient(135deg, 
        rgba(255, 127, 0, 0.95) 0%, 
        rgba(255, 140, 0, 0.98) 50%, 
        rgba(255, 165, 0, 0.95) 100%);
    }

    .kit-content {
      display: flex;
      flex-wrap: wrap;
      gap: clamp(2rem, 5vw, 6rem);
      align-items: center;
      justify-content: center;
      padding: 0 clamp(1rem, 4vw, 4rem);
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    .kit-content.reverse {
      flex-direction: row-reverse;
    }

    .kit-text {
      flex: 1 1 clamp(300px, 45%, 600px);
      min-width: 280px;
      padding: 2rem 0;
    }

    .kit-image {
      flex: 1 1 clamp(300px, 45%, 600px);
      min-width: 280px;
      width: 100%;
      height: clamp(300px, 40vw, 500px);
      background: linear-gradient(135deg, #D4A574 0%, #E6C89C 100%);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      overflow: hidden;
      border: 3px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    }

    .kit-text h3 {
      font-size: clamp(1.8rem, 4vw, 2.5rem);
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 2rem;
      line-height: 1.2;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      letter-spacing: -1px;
    }

    .kit-text p {
      color: rgba(255, 255, 255, 0.95);
      font-size: clamp(1rem, 2vw, 1.15rem);
      line-height: 1.8;
      text-align: left;
      opacity: 0.9;
    }

    .kit-image:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.15);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .placeholder-img {
      color: #ffffff;
      font-size: 1.1rem;
      font-weight: 600;
      text-align: center;
      z-index: 1;
      position: relative;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
    }

    /* AR Initial Overlay */
    .ar-initial-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 2rem;
    }

    .ar-initial-overlay.hidden {
      display: none;
    }

    .ar-initial-content {
      max-width: 600px;
      text-align: left;
      background: rgba(255, 140, 0, 0.95);
      padding: 2.5rem;
      border-radius: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .ar-initial-content h3 {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: #ffffff;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      text-align: center;
    }

    .ar-initial-instructions {
      margin-bottom: 2rem;
    }

    .ar-initial-instructions h4 {
      font-size: 1.2rem;
      font-weight: 600;
      color: #ffffff;
      margin: 1.5rem 0 1rem 0;
      border-left: 3px solid rgba(255, 255, 255, 0.6);
      padding-left: 1rem;
      background: rgba(255, 255, 255, 0.05);
      padding: 0.5rem 0 0.5rem 1rem;
      border-radius: 4px;
    }

    .ar-initial-instructions p {
      font-size: 1rem;
      line-height: 1.6;
      margin-bottom: 1rem;
      color: rgba(255, 255, 255, 0.9);
    }

    .ar-initial-instructions ul {
      margin-left: 1.5rem;
      margin-bottom: 1.5rem;
      background: rgba(255, 255, 255, 0.03);
      padding: 1rem;
      border-radius: 6px;
    }

    .ar-initial-instructions li {
      font-size: 0.95rem;
      line-height: 1.5;
      margin-bottom: 0.6rem;
      color: rgba(255, 255, 255, 0.9);
    }

    .ar-initial-instructions li strong {
      color: #ffffff;
      font-weight: 600;
    }

    .ar-start-button {
      background: #ffffff;
      color: #FF8C00;
      border: 2px solid #ffffff;
      padding: 1.2rem 2.5rem;
      font-size: 1rem;
      font-weight: 700;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
      display: block;
      margin: 2rem auto 0 auto;
      width: fit-content;
    }

    .ar-start-button:hover {
      background: #FF8C00;
      color: #ffffff;
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
    }
    .ar-instructions-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      display: none;
      z-index: 25;
      padding: 2rem;
      overflow-y: auto;
      backdrop-filter: blur(5px);
    }

    .ar-instructions-overlay.visible {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }

    .ar-instructions-content {
      max-width: 600px;
      margin: 2rem auto;
      text-align: left;
      background: rgba(255, 140, 0, 0.95);
      padding: 2rem;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .ar-instructions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 1rem;
    }

    .ar-instructions-header h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      margin: 0;
    }

    .ar-instructions-close {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.6rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      text-transform: uppercase;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }

    .ar-instructions-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }

    .ar-instructions-section {
      margin-bottom: 1.5rem;
    }

    .ar-instructions-section h4 {
      font-size: 1.1rem;
      font-weight: 600;
      color: white;
      margin-bottom: 0.8rem;
      border-left: 3px solid rgba(255, 255, 255, 0.5);
      padding-left: 0.8rem;
    }

    .ar-instructions-section p {
      font-size: 0.95rem;
      line-height: 1.6;
      margin-bottom: 0.8rem;
      color: rgba(255, 255, 255, 0.9);
    }

    .ar-instructions-section ul {
      margin-left: 1rem;
      margin-bottom: 0.8rem;
    }

    .ar-instructions-section li {
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 0.4rem;
      color: rgba(255, 255, 255, 0.9);
    }

    .ar-help-button {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background: rgba(255, 140, 0, 0.8);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.8rem 1.2rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      z-index: 15;
      transition: all 0.3s ease;
      text-transform: uppercase;
      font-size: 0.9rem;
    }

    .ar-help-button:hover {
      background: rgba(255, 140, 0, 0.9);
      transform: translateY(-1px);
    }

    /* Kit Detail Screen */
    #kitDetailScreen {
      display: none;
      min-height: 100vh;
      padding: 4rem 0;
      background-color: #FF8C00;
    }

    .kit-detail {
      display: grid;
      grid-template-columns: 500px 1fr;
      gap: 5rem;
      align-items: start;
      background: #FF7F00;
      padding: 3rem;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .kit-detail-image {
      width: 100%;
      height: 400px;
      background: linear-gradient(135deg, #D4A574 0%, #E6C89C 100%);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      border: 2px solid #ffffff;
    }

    .kit-detail-text h2 {
      font-size: 2.5rem;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 2rem;
      line-height: 1.2;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .kit-detail-text p {
      font-size: 1.1rem;
      color: #ffffff;
      line-height: 1.8;
      margin-bottom: 2.5rem;
      text-align: justify;
    }

    .back-button {
      background: #ffffff;
      color: #FF8C00;
      border: 2px solid #ffffff;
      padding: 1rem 2rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
    }

    .back-button:hover {
      background: #FF8C00;
      color: #ffffff;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
    }

    /* AR Screen */
    #arScreen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: #000000;
      z-index: 1000;
    }

    .ar-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255, 140, 0, 0.9);
      color: #ffffff;
      padding: 1.5rem;
      text-align: center;
      z-index: 10;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid #ffffff;
    }

    .ar-back-button {
      position: absolute;
      top: 1.5rem;
      left: 1.5rem;
      background: #ffffff;
      color: #FF8C00;
      border: 2px solid #ffffff;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      z-index: 20;
      transition: all 0.3s ease;
      text-transform: uppercase;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .ar-back-button:hover {
      background: #FF8C00;
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    }

    .ar-container {
      width: 100%;
      height: 100%;
      position: relative;
    }

    #video { display: none; }
    #canvas { display: none; }

    #threeContainer {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: auto;
      height: 100%;
      z-index: 5;
    }

    /* AR Background to cover black void */
    .ar-background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #FF8C00 0%, #FF7F00 100%);
      z-index: 1;
    }

    .ar-sidebar {
      position: absolute;
      top: 0;
      right: 0;
      width: 450px;
      height: 100%;
      background: rgba(255, 127, 0, 0.95);
      backdrop-filter: blur(10px);
      padding: 2rem;
      box-shadow: -4px 0 16px rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      z-index: 15;
      border-left: 2px solid #ffffff;
    }

    /* Left sidebar for additional coverage */
    .ar-left-panel {
      position: absolute;
      top: 0;
      left: 0;
      width: 150px;
      height: 100%;
      background: rgba(255, 140, 0, 0.95);
      backdrop-filter: blur(10px);
      z-index: 14;
      border-right: 2px solid rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ar-left-panel::before {
      content: 'AUTOMATA\AAAAR';
      writing-mode: vertical-lr;
      text-orientation: mixed;
      color: rgba(255, 255, 255, 0.6);
      font-size: 1.2rem;
      font-weight: 700;
      letter-spacing: 3px;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .ar-sidebar h3 {
      font-size: 1.3rem;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 1.5rem;
      text-align: center;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
    }

    .ar-kit-info {
      flex: 1;
      overflow-y: auto;
    }

    .ar-kit-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 1rem;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
    }

    .ar-kit-desc {
      font-size: 0.95rem;
      color: #ffffff;
      line-height: 1.6;
    }

    .debug-button {
      background: #ffffff;
      color: #FF8C00;
      border: 2px solid #ffffff;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      margin-top: 2rem;
      transition: all 0.3s ease;
      text-transform: uppercase;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
    }

    .debug-button:hover {
      background: #FF8C00;
      color: #ffffff;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
    }

    /* Debug overlay */
    .debug-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      color: white;
      display: none;
      z-index: 1001;
      padding: 2rem;
      overflow-y: auto;
    }

    .debug-overlay.visible {
      display: block;
    }

    .debug-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .debug-header h3 {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .debug-close {
      background: #666666;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
    }

    .debug-overlay-header {
      display: flex; 
      align-items: center; 
      justify-content: space-between;
    }
    .debug-overlay-header h3 {
      margin: 0;
    }

    .marker-info {
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      margin-bottom: 2rem;
      background: rgba(255,255,255,0.1);
      padding: 1rem;
      border-radius: 8px;
    }

    .debug-canvas-container {
      text-align: center;
      background: rgba(255,255,255,0.1);
      padding: 1rem;
      border-radius: 8px;
    }

    #debugCanvas {
      border: 1px solid #666666;
      max-width: 100%;
      height: auto;
    }

    /* Parallax Scrolling Effect */
    .parallax-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 120%;
      background: linear-gradient(135deg, #FF8C00 0%, #FF7F00 50%, #FF6600 100%);
      z-index: -1;
      transform: translateZ(0);
    }

    /* Mobile Responsive - Enhanced Flexbox */
    @media (max-width: 900px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }

      .header-buttons {
        order: -1;
      }

      .header-bar h1 {
        font-size: 1.5rem;
      }

      .header-ar-button {
        padding: 0.6rem 1rem;
        font-size: 0.8rem;
      }

      .intro-section {
        padding: 2rem 1rem;
      }

      .intro-section h2 {
        font-size: clamp(2rem, 8vw, 3rem);
        margin-bottom: 1.5rem;
      }

      .intro-section p {
        font-size: clamp(1rem, 4vw, 1.2rem);
        margin-bottom: 2rem;
      }

      /* Flexbox mobile adjustments */
      .kit-content,
      .kit-content.reverse {
        flex-direction: column;
        gap: clamp(1.5rem, 4vw, 3rem);
        text-align: center;
        padding: 0 clamp(1rem, 3vw, 2rem);
      }

      .kit-text {
        order: 2;
        flex: none;
        padding: 1rem 0;
        min-width: unset;
      }

      .kit-image {
        order: 1;
        flex: none;
        height: clamp(250px, 50vw, 350px);
        margin-bottom: 1rem;
        min-width: unset;
      }

      .kit-section {
        padding: 2rem 0;
        min-height: auto;
      }

      .kit-detail {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        padding: 2rem;
      }

      .ar-initial-content {
        padding: 2rem 1rem;
      }

      .ar-initial-content h3 {
        font-size: 1.5rem;
      }

      .ar-instructions-content {
        margin: 1rem;
        padding: 1.5rem;
      }

      .ar-instructions-header {
        flex-direction: column;
        gap: 1rem;
      }

      .ar-help-button {
        top: 1rem;
        right: 1rem;
        padding: 0.6rem 1rem;
        font-size: 0.8rem;
      }

      #threeContainer {
        left: 50%;
        transform: translateX(-50%);
        width: auto;
      }

      .ar-left-panel {
        display: none;
      }

      .ar-sidebar {
        position: fixed;
        bottom: 0;
        right: 0;
        width: 100%;
        height: 200px;
        padding: 1rem;
      }

      /* Disable complex animations on mobile for performance */
      .kit-content {
        transition: none !important;
      }
      
      .kit-image:hover {
        transform: translateY(-5px) scale(1.01);
      }
    }

    /* Ultra-small screens */
    @media (max-width: 480px) {
      .kit-content {
        padding: 0 1rem;
        gap: 1.5rem;
      }

      .kit-image {
        height: 200px;
      }

      .intro-section {
        padding: 1.5rem 0.5rem;
      }
    }

    /* Apple-style enhancements */
    .kit-content {
      will-change: transform, opacity;
    }

    .parallax-element {
      will-change: transform;
    }

    /* Smooth momentum scrolling for iOS */
    #homeScreen {
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>
<body>
  <!-- Parallax Background -->
  <div class="parallax-bg"></div>

  <!-- Header -->
  <div class="header-bar" id="mainHeader" style="display: flex;">
    <div class="header-content">
      <div></div> <!-- Empty div for spacing -->
      <h1>AUTOMATA AR</h1>
      <div class="header-buttons">
        <button class="header-ar-button" id="openARBtn">Open AR</button>
      </div>
    </div>
  </div>

  <!-- Home Screen -->
  <section id="homeScreen" style="display: block;">
    <!-- Intro -->
    <div class="intro-section">
      <div class="container">
        <h2>Welcome to Automata AR</h2>
        <p>Explore mechanical engineering concepts through augmented reality. Point your camera at kit markers to see interactive 3D demonstrations of gears, cams, cranks, and other mechanical systems.</p>
      </div>
    </div>

    <!-- Cam-A Kit -->
    <div class="kit-section animate-on-scroll fade-left">
      <div class="kit-content scroll-content">
        <div class="kit-text progressive-reveal">
          <h3>Cam-A: Learn the details of rotational motion</h3>
          <p>Demonstrates how cams convert rotational motion into linear oscillatory motion using contoured surfaces to drive followers in precise, complex patterns.</p>
        </div>
        <div class="kit-image parallax-element" onclick="showKitDetail(0)" style="background-image: url('images/kit1.png');">
        </div>
      </div>
    </div>

    <!-- Cam-C Kit -->
    <div class="kit-section animate-on-scroll fade-right">
      <div class="kit-content reverse scroll-content">
        <div class="kit-image parallax-element" onclick="showKitDetail(1)" style="background-image: url('images/kit2.png');">
        </div>
        <div class="kit-text progressive-reveal">
          <h3>Cam-C: Get to know more about intermittent motion</h3>
          <p>Shows how a Geneva wheel mechanism creates precise, timed intermittent motion from continuous rotational input using pins and slots.</p>
        </div>
      </div>
    </div>

    <!-- Crank Kit -->
    <div class="kit-section animate-on-scroll fade-left">
      <div class="kit-content scroll-content">
        <div class="kit-text progressive-reveal">
          <h3>Crank: Understanding reciprocating motion</h3>
          <p>Illustrates how a rotating crank arm converts rotational motion into linear back-and-forth movement through connecting rods.</p>
        </div>
        <div class="kit-image parallax-element" onclick="showKitDetail(2)" style="background-image: url('images/kit3.png');">
        </div>
      </div>
    </div>

    <!-- Gear-A Kit -->
    <div class="kit-section animate-on-scroll fade-right">
      <div class="kit-content reverse scroll-content">
        <div class="kit-image parallax-element" onclick="showKitDetail(3)" style="background-image: url('images/kit4.png');">
        </div>
        <div class="kit-text progressive-reveal">
          <h3>Gear-A: Exploring perpendicular power transmission</h3>
          <p>Demonstrates how bevel gears with cone-shaped teeth transfer rotational motion between perpendicular shafts at 90-degree angles.</p>
        </div>
      </div>
    </div>

    <!-- Gear-B Kit -->
    <div class="kit-section animate-on-scroll fade-left">
      <div class="kit-content scroll-content">
        <div class="kit-text progressive-reveal">
          <h3>Gear-B: Variable speed and torque systems</h3>
          <p>Shows how gear alignment and shape create variable speed and torque output from constant input through dynamic load distribution.</p>
        </div>
        <div class="kit-image parallax-element" onclick="showKitDetail(4)" style="background-image: url('images/kit5.png');">
        </div>
      </div>
    </div>

    <!-- Gear-C Kit -->
    <div class="kit-section animate-on-scroll scale-in">
      <div class="kit-content reverse scroll-content">
        <div class="kit-image parallax-element" onclick="showKitDetail(5)" style="background-image: url('images/kit6.png');">
        </div>
        <div class="kit-text progressive-reveal">
          <h3>Gear-C: Mastering worm gear systems</h3>
          <p>Features a worm gear system that significantly reduces speed while increasing torque with self-locking capability to prevent back-driving.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Kit Detail Screen -->
  <section id="kitDetailScreen">
    <div class="container">
      <div class="kit-detail">
        <div class="kit-detail-image kit-detail-img">
          <div class="placeholder-img" id="kitDetailImg">Kit Image</div>
        </div>
        <div class="kit-detail-text">
          <h2 id="kitDetailTitle">Kit Name</h2>
          <p id="kitDetailDesc">Kit description will appear here.</p>
          <button class="back-button" id="kitBackHomeBtn">Back to Home</button>
        </div>
      </div>
    </div>
  </section>

  <!-- AR Screen -->
  <section id="arScreen">
    <!-- AR Initial Overlay -->
    <div class="ar-initial-overlay" id="arInitialOverlay">
      <div class="ar-initial-content">
        <h3>AR Instructions</h3>
        
        <div class="ar-instructions-grid">
          <div class="ar-instruction-item">
            <h4>Setup</h4>
            <p>Hold device steady. Point camera at ArUco marker (black/white square pattern). Keep marker flat and fully visible.</p>
          </div>
          
          <div class="ar-instruction-item">
            <h4>Distance</h4>
            <p>Stay 6-18 inches from marker. Ensure good lighting. Avoid shadows on markers.</p>
          </div>
          
          <div class="ar-instruction-item">
            <h4>Usage</h4>
            <p>3D models appear on detected markers. Move marker or camera to view different angles. Each kit has unique marker.</p>
          </div>
          
          <div class="ar-instruction-item">
            <h4>Troubleshooting</h4>
            <p>If detection fails, adjust distance/angle. Use Debug View button to see camera detection. Keep markers flat.</p>
          </div>
        </div>
        
        <button class="ar-start-button" id="arStartButton">Start Camera</button>
      </div>
    </div>

    <!-- AR Background to cover black void -->
    <div class="ar-background"></div>
    
    <div class="ar-header">
      <p><strong>Instructions:</strong> Point your camera at a kit marker to see the 3D demonstration</p>
    </div>
    <button class="ar-back-button" id="backHomeBtn">← Back to Home</button>
    <button class="ar-help-button" id="arHelpBtn">Help</button>

    <!-- Left panel for additional coverage -->
    <div class="ar-left-panel"></div>

    <div class="ar-container">
      <video id="video" width="320" height="240" autoplay playsinline muted></video>
      <canvas id="canvas" width="320" height="240"></canvas>
      <div id="threeContainer"></div>
    </div>

    <div class="ar-sidebar">
      <h3>Kit Information</h3>
      <div class="ar-kit-info">
        <div class="ar-kit-name" id="arKitName">No kits detected</div>
        <div class="ar-kit-desc" id="arKitDesc">Point your camera at a marker to see kit information</div>
      </div>
      <button class="debug-button" id="debugSideBtn">Debug View</button>
    </div>

    <!-- AR Instructions Overlay -->
    <div class="ar-instructions-overlay" id="arInstructionsOverlay">
      <div class="ar-instructions-content">
        <div class="ar-instructions-header">
          <h3>AR Instructions</h3>
          <button class="ar-instructions-close" id="arInstructionsClose">Close</button>
        </div>
        
        <div class="ar-instructions-section">
          <h4>How to Use</h4>
          <ul>
            <li>Allow camera access when prompted</li>
            <li>Point your camera at a kit marker (ArUco marker)</li>
            <li>Keep the marker flat and fully visible</li>
            <li>Move the marker to see the 3D model from different angles</li>
          </ul>
        </div>

        <div class="ar-instructions-section">
          <h4>Available Kits</h4>
          <p><strong>Cam-A:</strong> Rotational to linear motion</p>
          <p><strong>Cam-C:</strong> Intermittent motion (Geneva wheel)</p>
          <p><strong>Crank:</strong> Reciprocating motion</p>
          <p><strong>Gear-A:</strong> Bevel gears (90° transmission)</p>
          <p><strong>Gear-B:</strong> Variable speed gears</p>
          <p><strong>Gear-C:</strong> Worm gear systems</p>
        </div>

        <div class="ar-instructions-section">
          <h4>Troubleshooting</h4>
          <ul>
            <li>Ensure good lighting conditions</li>
            <li>Keep markers flat and steady</li>
            <li>Try adjusting distance to marker</li>
            <li>Use Debug view to check marker detection</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Debug overlay -->
    <div class="debug-overlay" id="debugOverlay">
      <div class="debug-overlay-header">
        <h3>Debug Information</h3>
        <button class="debug-close" onclick="toggleDebugOverlay()">Close</button>
      </div>
      <div class="marker-info" id="markerInfo">No debug information available</div>
      <div class="debug-canvas-container">
        <canvas id="debugCanvas" width="320" height="240"></canvas>
      </div>
    </div>
  </section>

  <script>
    /********************************************
     * APPLE-STYLE SCROLL ANIMATIONS
     ********************************************/
    
    // Enhanced Intersection Observer for Apple-style animations
    const observerOptions = {
      threshold: [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1],
      rootMargin: '0px 0px -10% 0px'
    };

    // Create multiple observers for different animation types
    const fadeObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const element = entry.target;
        const ratio = entry.intersectionRatio;
        
        if (entry.isIntersecting && ratio > 0.1) {
          element.classList.add('animate');
          // Add staggered animation for child elements
          const children = element.querySelectorAll('.kit-text, .kit-image');
          children.forEach((child, index) => {
            setTimeout(() => {
              child.style.opacity = '1';
              child.style.transform = 'translateY(0) scale(1)';
            }, index * 200);
          });
        }
      });
    }, observerOptions);

    // Progress-based scroll animations
    const progressObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const element = entry.target;
        const ratio = entry.intersectionRatio;
        
        // Skip intro section - keep it fully visible
        if (element.classList.contains('intro-section')) {
          return;
        }
        
        // Calculate progress-based transforms
        const translateY = (1 - ratio) * 30;
        const scale = 0.95 + (ratio * 0.05);
        const opacity = Math.max(0.3, ratio);
        
        if (element.querySelector('.kit-content')) {
          const content = element.querySelector('.kit-content');
          content.style.transform = `translateY(${translateY}px) scale(${scale})`;
          content.style.opacity = opacity;
        }
      });
    }, {
      threshold: [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1],
      rootMargin: '0px'
    });

    // Parallax effect for background elements
    function handleAdvancedParallax() {
      const scrolled = window.pageYOffset;
      const rate = scrolled * -0.3;
      const parallaxBg = document.querySelector('.parallax-bg');
      
      if (parallaxBg) {
        parallaxBg.style.transform = `translate3d(0, ${rate}px, 0)`;
      }

      // Individual section parallax
      const sections = document.querySelectorAll('.kit-section');
      sections.forEach((section, index) => {
        const rect = section.getBoundingClientRect();
        const speed = (index % 2 === 0) ? 0.5 : -0.3;
        const yPos = rect.top * speed;
        
        const image = section.querySelector('.kit-image');
        if (image && rect.top < window.innerHeight && rect.bottom > 0) {
          image.style.transform = `translateY(${yPos}px)`;
        }
      });
    }

    // Smooth section scrolling with momentum
    function initSmoothScrolling() {
      const sections = document.querySelectorAll('.scroll-section, .kit-section, .intro-section');
      let currentSection = 0;
      let isScrolling = false;

      function scrollToSection(index) {
        if (index >= 0 && index < sections.length && !isScrolling) {
          isScrolling = true;
          sections[index].scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
          });
          
          setTimeout(() => {
            isScrolling = false;
          }, 1000);
        }
      }

      // Enhanced wheel event handling
      window.addEventListener('wheel', (e) => {
        if (isScrolling) return;
        
        const delta = e.deltaY;
        if (Math.abs(delta) > 50) {
          if (delta > 0 && currentSection < sections.length - 1) {
            currentSection++;
            scrollToSection(currentSection);
          } else if (delta < 0 && currentSection > 0) {
            currentSection--;
            scrollToSection(currentSection);
          }
        }
      }, { passive: false });

      // Touch support for mobile
      let touchStartY = 0;
      window.addEventListener('touchstart', (e) => {
        touchStartY = e.touches[0].clientY;
      });

      window.addEventListener('touchend', (e) => {
        const touchEndY = e.changedTouches[0].clientY;
        const diff = touchStartY - touchEndY;
        
        if (Math.abs(diff) > 50) {
          if (diff > 0 && currentSection < sections.length - 1) {
            currentSection++;
            scrollToSection(currentSection);
          } else if (diff < 0 && currentSection > 0) {
            currentSection--;
            scrollToSection(currentSection);
          }
        }
      });
    }

    // Progressive content reveal
    function initProgressiveReveal() {
      const revealElements = document.querySelectorAll('.kit-text, .intro-section');
      
      revealElements.forEach(element => {
        element.classList.add('progressive-reveal');
        
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              setTimeout(() => {
                entry.target.classList.add('revealed');
              }, 100);
            }
          });
        }, { threshold: 0.3 });
        
        observer.observe(element);
      });
    }

    // Enhanced scroll animations initialization
    function initScrollAnimations() {
      // Observe all animated elements
      const animatedElements = document.querySelectorAll('.animate-on-scroll, .kit-section');
      animatedElements.forEach(el => {
        fadeObserver.observe(el);
        progressObserver.observe(el);
      });

      // Add advanced parallax scrolling
      window.addEventListener('scroll', handleAdvancedParallax, { passive: true });
      
      // Initialize smooth section scrolling
      initSmoothScrolling();
      
      // Initialize progressive reveal
      initProgressiveReveal();
      
      // Initial setup for elements
      animatedElements.forEach((el, index) => {
        // Skip intro section - keep it fully visible
        if (el.classList.contains('intro-section')) {
          return;
        }
        
        const content = el.querySelector('.kit-content');
        if (content) {
          content.style.opacity = '0.3';
          content.style.transform = 'translateY(30px) scale(0.95)';
          content.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        }
      });
    }

    /********************************************
     * GLOBAL STATE & CONSTANTS
     ********************************************/
    const PAGE_HOME = "HOME";
    const PAGE_KIT_DETAIL = "KITDETAIL";
    const PAGE_AR = "AR";

    window.onload = function() {
      setupUI();
      showHomeScreen();  // Always start with home screen
      initScrollAnimations(); // Initialize scroll animations
    };

    function showHomeScreen(){
      document.getElementById("mainHeader").style.display = "flex";
      document.getElementById("homeScreen").style.display = "block";
      document.getElementById("kitDetailScreen").style.display = "none";
      document.getElementById("arScreen").style.display = "none";
      
      // Reset AR overlay for next time
      document.getElementById("arInitialOverlay").classList.remove("hidden");
      
      // Reset Apple-style scroll animations
      const scrollContents = document.querySelectorAll('.scroll-content');
      scrollContents.forEach(content => {
        // Don't reset intro section - keep it visible
        if (!content.closest('.intro-section')) {
          content.classList.remove('in-view');
          content.style.opacity = '0.3';
          content.style.transform = 'translateY(60px)';
        }
      });

      const progressiveElements = document.querySelectorAll('.progressive-reveal');
      progressiveElements.forEach(el => {
        el.classList.remove('revealed');
      });
      
      // Scroll to top smoothly
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      // Re-initialize scroll animations after a brief delay
      setTimeout(() => {
        initScrollAnimations();
        // Trigger intro animation immediately - no need to find scroll-content in intro
        const introTitle = document.querySelector('.intro-section h2');
        const introText = document.querySelector('.intro-section p');
        if (introTitle) {
          introTitle.style.color = '#ffffff';
          introTitle.style.opacity = '1';
        }
        if (introText) {
          introText.style.color = '#ffffff';
          introText.style.opacity = '1';
        }
      }, 100);
    }

    function showKitDetailScreen(kitID){
      document.getElementById("mainHeader").style.display = "none";
      // Fill placeholders
      const kit = scenarios[kitID];
      document.getElementById("kitDetailTitle").textContent = kit ? kit.name : "Unknown Kit";
      document.getElementById("kitDetailDesc").textContent = kit ? kit.desc : "No description found.";

      document.querySelector(".kit-detail-img").style.backgroundImage = `url("images/kit${kitID+1}.png")`;
      // Hide placeholder text when image is loaded
      document.getElementById("kitDetailImg").style.display = "none";

      document.getElementById("homeScreen").style.display = "none";
      document.getElementById("kitDetailScreen").style.display = "block";
      document.getElementById("arScreen").style.display = "none";
    }

    function showKitDetail(kitID) {
      showKitDetailScreen(kitID);
    }

    function showARScreen(){
      document.getElementById("mainHeader").style.display = "none";
      document.getElementById("homeScreen").style.display = "none";
      document.getElementById("kitDetailScreen").style.display = "none";
      document.getElementById("arScreen").style.display = "block";
      
      // Show the initial overlay - don't start AR yet
      document.getElementById("arInitialOverlay").classList.remove("hidden");
    }

    function startARExperience(){
      // Hide the initial overlay
      document.getElementById("arInitialOverlay").classList.add("hidden");
      
      // Now initialize AR with camera
      if(!video) {
        initAR();
      }
    }

    function setupUI(){
      // Home -> AR
      document.getElementById("openARBtn").onclick = function(){
        showARScreen();
      };
      // Kit detail -> Home
      document.getElementById("kitBackHomeBtn").onclick = function(){
        showHomeScreen();
      };
      // AR -> Home
      document.getElementById("backHomeBtn").onclick = function(){
        showHomeScreen();
      };
      // Debug overlay
      document.getElementById("debugSideBtn").onclick = toggleDebugOverlay;
      
      // AR instructions overlay handlers
      document.getElementById("arHelpBtn").onclick = toggleARInstructionsOverlay;
      document.getElementById("arInstructionsClose").onclick = toggleARInstructionsOverlay;
      
      // AR start button
      document.getElementById("arStartButton").onclick = function(){
        startARExperience();
      };
    }

    function toggleARInstructionsOverlay() {
      const overlay = document.getElementById("arInstructionsOverlay");
      overlay.classList.toggle("visible");
    }

    /********************************************
     * AR LOGIC
     ********************************************/
    var video, canvas, context, imageData;
    var renderer, scene, camera, backgroundScene, backgroundCamera, videoTexture;
    var detector, posit;
    var adaptiveFilter, multiScaleDetector, opticalFlowTracker;
    var useAdaptiveFilter=false, useMultiScale=false, useOpticalFlow=false;
    var modelSize=35.0;
    var lastActiveIdentifierTag=null;
    var scenarioConfidence = {
      // Existing kits (0–5)
      0: 0,
      1: 0,
      2: 0,
      3: 0,
      4: 0,
      5: 0,
    
      // New scenario IDs (6–31):
      6: 0,
      7: 0,
      8: 0,
      9: 0,
      10: 0,
      11: 0,
      12: 0,
      13: 0,
      14: 0,
      15: 0,
      16: 0,
      17: 0,
      18: 0,
      19: 0,
      20: 0,
      21: 0,
      22: 0,
      23: 0,
      24: 0,
      25: 0,
      26: 0,
      27: 0,
      28: 0,
      29: 0,
      30: 0,
      31: 0
    };    
    var SCENARIO_CONFIDENCE_THRESHOLD=3;
    var stlLoader=null;
    var stlCache={};
    var lastFrameMarkers=[];

    /* 
      Updated scenario objects with your new DESCRIPTIONS 
      Cam-A, Cam-C, Crank, Gear-A, Gear-B, Gear-C
    */
    var scenarios = [
      {
        name: "Cam-A",
        identifierTag: 0,
        desc: `Cam-A, illustrates how cams convert rotational motion into linear oscillatory motion. 
Cam: The cam is a rotating or sliding piece in a mechanical linkage that drives the follower. 
The cam's surface can be contoured (circular, elliptical, etc.) to create different motion 
in the follower as the cam rotates. The cam mechanism's ability to produce precise, complex 
motion from simple rotational input makes it invaluable in mechanical design. It's used in 
internal engines, filling/packing machines, and more.`,
        objects: [
          { tag: 6, stl: "sea_models/stringray.stl" }
        ]
      },
      {
        name: "Cam-C",
        identifierTag: 1,
        desc: `Cam-C illustrates how cams convert rotational motion to arranged, paused (intermittent) motion. 
It's a rotating drive wheel (driver) with a pin engaging slots in a driven wheel (Geneva wheel). 
This engagement causes precise timing & indexing. Between steps, the Geneva wheel remains locked 
in place. Widely used in clockwork, film projectors, assembly lines, etc., for controlled, 
intermittent motion from continuous input.`,
        objects: [
          { tag: 7, stl: "sea_models/jellyfish.stl" }
        ]
      },
      {
        name: "Crank",
        identifierTag: 2,
        desc: `Crank kit illustrates how a crank mechanism converts rotational motion into linear reciprocating motion. 
A rotating arm (the crank) pushes/pulls a connecting rod, creating back-and-forth movement. This 
simple but effective design ensures consistent rotation-to-reciprocation transfer. Used in engines, 
pumps, and presses, whenever converting rotary motion into linear is essential.`,
        objects: [
          { tag: 8, stl: "sea_models/dolphin.stl" }
        ]
      },
      {
        name: "Gear-A",
        identifierTag: 3,
        desc: `Gear-A demonstrates how bevel gears transfer rotational motion between perpendicular shafts, 
turning horizontal circular motion into vertical. Bevel gears have cone-shaped teeth meeting at 90°, 
redirecting motion while maintaining power transmission. Widely used in automobiles, drills, and 
other machinery needing efficient angled power transfer.`,
        objects: [
          { tag: 9, stl: "sea_models/octopus.stl" }
        ]
      },
      {
        name: "Gear-B",
        identifierTag: 4,
        desc: `Gear-B shows how gear alignment & shape affect torque/speed, even with a constant driver. This 
mechanism can cause continuous speed variation due to shifting alignment of the gears. The driver's 
turning changes load distribution, resulting in dynamic acceleration/deceleration. These "weird" 
gears are useful for specialized systems needing variable torque & non-uniform motion, e.g. 
adaptive transmissions.`,
        objects: [
          { tag: 10, stl: "sea_models/fishes.stl" }
        ]
      },
      {
        name: "Gear-C",
        identifierTag: 5,
        desc: `Gear-C is a worm gear system that converts rotational motion while significantly reducing speed & 
increasing torque. A screw-like worm drives a worm wheel, transferring motion at 90°. This design 
offers high torque output & a self-locking feature, so it can't be back-driven. Used in elevators, 
conveyors, tuning mechanisms—anywhere controlled motion & torque multiplication are vital.`,
        objects: [
          { tag: 11, stl: "sea_models/sea_turtle.stl" }
        ]
      },
      // 7th scenario (marker ID = 6)
      {
        name: "Octopus Baby Exotic T 0409195159",
        identifierTag: 6,
        desc: "An adorable baby exotic octopus, with texture from 0409195159.",
        objects: [
          {
            tag: 6,
            stl: "octopus_baby_exotic_t_0409195159_texture.stl"
          }
        ]
      },

      // 8th scenario (ID = 7)
      {
        name: "Octopus Exotic Tropic 0409194610",
        identifierTag: 7,
        desc: "A colorful tropical octopus from 0409194610.",
        objects: [
          {
            tag: 7,
            stl: "octopus_exotic_tropic_0409194610_texture.stl"
          }
        ]
      },

      {
        name: "Coral Reef Fish Uniqu 0409193350",
        identifierTag: 8,
        desc: "A unique coral reef fish (3350).",
        objects: [
          {
            tag: 8,
            stl: "coral_reef_fish_uniqu_0409193350_texture.stl"
          }
        ]
      },

      {
        name: "Marine Animal Exotic 0409191724",
        identifierTag: 9,
        desc: "An exotic marine creature, ID 1724.",
        objects: [
          {
            tag: 9,
            stl: "marine_animal_exotic__0409191724_texture.stl"
          }
        ]
      },

      {
        name: "Jellyfish Exotic Trop 0409193559",
        identifierTag: 10,
        desc: "An exotic tropical jellyfish, ID 3559.",
        objects: [
          {
            tag: 10,
            stl: "jellyfish_exotic_trop_0409193559_texture.stl"
          }
        ]
      },

      {
        name: "Marine Animal Exotic 0409191414",
        identifierTag: 11,
        desc: "Another exotic marine animal, ID 1414.",
        objects: [
          {
            tag: 11,
            stl: "marine_animal_exotic__0409191414_texture.stl"
          }
        ]
      },

      {
        name: "Jellyfish Exotic Trop 0409194017",
        identifierTag: 12,
        desc: "A second exotic jellyfish with texture ID 4017.",
        objects: [
          {
            tag: 12,
            stl: "jellyfish_exotic_trop_0409194017_texture.stl"
          }
        ]
      },

      {
        name: "Jellyfish Exotic Trop 0409193124",
        identifierTag: 13,
        desc: "A third jellyfish (3124).",
        objects: [
          {
            tag: 13,
            stl: "jellyfish_exotic_trop_0409193124_texture.stl"
          }
        ]
      },

      {
        name: "Pufferfish Lionfish 0409194030",
        identifierTag: 14,
        desc: "A hybrid puffer–lionfish (4030).",
        objects: [
          {
            tag: 14,
            stl: "pufferfish_lionfish_0409194030_texture.stl"
          }
        ]
      },

      {
        name: "Octopus 0409192644",
        identifierTag: 15,
        desc: "A second octopus, ID 2644.",
        objects: [
          {
            tag: 15,
            stl: "octopus_0409192644_texture.stl"
          }
        ]
      },

      {
        name: "Exotic Manta Ray Diff 0409192058",
        identifierTag: 16,
        desc: "An exotic manta ray (2058).",
        objects: [
          {
            tag: 16,
            stl: "exotic_manta_ray_diff_0409192058_texture.stl"
          }
        ]
      },

      {
        name: "Shark Manta Ray Diffe 0409190832",
        identifierTag: 17,
        desc: "A combo shark/manta ray, ID 0832.",
        objects: [
          {
            tag: 17,
            stl: "shark_manta_ray_diffe_0409190832_texture.stl"
          }
        ]
      },

      {
        name: "Exotic Manta Ray Diff 0409191733",
        identifierTag: 18,
        desc: "Another exotic manta ray (1733).",
        objects: [
          {
            tag: 18,
            stl: "exotic_manta_ray_diff_0409191733_texture.stl"
          }
        ]
      },

      {
        name: "Coral Reef Fish Uniqu 0409193604",
        identifierTag: 19,
        desc: "Coral reef fish (3604).",
        objects: [
          {
            tag: 19,
            stl: "coral_reef_fish_uniqu_0409193604_texture.stl"
          }
        ]
      },

      {
        name: "Extinct Fish Species 0409190726",
        identifierTag: 20,
        desc: "An extinct fish species (0726).",
        objects: [
          {
            tag: 20,
            stl: "extinct_fish_species__0409190726_texture.stl"
          }
        ]
      },

      {
        name: "Coral Reef Fish Uniqu 0409192753",
        identifierTag: 21,
        desc: "A second unique reef fish (2753).",
        objects: [
          {
            tag: 21,
            stl: "coral_reef_fish_uniqu_0409192753_texture.stl"
          }
        ]
      },

      {
        name: "Exotic Manta Ray Diff 0409191419",
        identifierTag: 22,
        desc: "An exotic manta ray (1419).",
        objects: [
          {
            tag: 22,
            stl: "exotic_manta_ray_diff_0409191419_texture.stl"
          }
        ]
      },

      {
        name: "Coral Reef Fish Uniqu 0409193118",
        identifierTag: 23,
        desc: "Yet another coral reef fish (3118).",
        objects: [
          {
            tag: 23,
            stl: "coral_reef_fish_uniqu_0409193118_texture.stl"
          }
        ]
      },

      {
        name: "Marine Animal Exotic 0409185056",
        identifierTag: 24,
        desc: "An exotic marine animal (5056).",
        objects: [
          {
            tag: 24,
            stl: "marine_animal_exotic__0409185056_texture.stl"
          }
        ]
      },

      {
        name: "Fish Exotic 0409185227",
        identifierTag: 25,
        desc: "A fish labeled 'exotic' (5227).",
        objects: [
          {
            tag: 25,
            stl: "fish_exotic_0409185227_texture.stl"
          }
        ]
      },

      {
        name: "Fish Tropical 0409184753",
        identifierTag: 26,
        desc: "A tropical fish (4753).",
        objects: [
          {
            tag: 26,
            stl: "fish_tropical_0409184753_texture.stl"
          }
        ]
      },

      {
        name: "Fish Tropical 0409184433",
        identifierTag: 27,
        desc: "Another tropical fish (4433).",
        objects: [
          {
            tag: 27,
            stl: "fish_tropical_0409184433_texture.stl"
          }
        ]
      },

      {
        name: "Marine Animal Exotic 0409190024",
        identifierTag: 28,
        desc: "Marine animal (0024).",
        objects: [
          {
            tag: 28,
            stl: "marine_animal_exotic__0409190024_texture.stl"
          }
        ]
      },

      {
        name: "Whale Different Speci 0409190151",
        identifierTag: 29,
        desc: "A whale, ID 0151.",
        objects: [
          {
            tag: 29,
            stl: "whale_different_speci_0409190151_texture.stl"
          }
        ]
      },

      {
        name: "Marine Animal Exotic 0409185506",
        identifierTag: 30,
        desc: "Another exotic sea creature (5506).",
        objects: [
          {
            tag: 30,
            stl: "marine_animal_exotic__0409185506_texture.stl"
          }
        ]
      },

      {
        name: "Fish Tropical 0409190013",
        identifierTag: 31,
        desc: "A final tropical fish, ID 0013.",
        objects: [
          {
            tag: 31,
            stl: "fish_tropical_0409190013_texture.stl"
          }
        ]
      }
    
    ];

    function initAR(){
      video = document.getElementById("video");
      canvas = document.getElementById("canvas");
      context = canvas.getContext("2d");
      detector = new AR.Detector();
      posit = new POS.Posit(modelSize, canvas.width);

      adaptiveFilter = new AdaptiveThresholdFilter({ blockSize:21, C:5, useIntegralImage:true });
      multiScaleDetector = new MultiScaleDetector({ 
        detector: detector, 
        scales:[1.0,0.5,1.5], 
        confidenceThreshold:0.3 
      });
      opticalFlowTracker = new OpticalFlowTracker({
        winSize:15, maxError:10000, maxMotion:50, maxTrackedFrames:30
      });

      initCamera();
      initRenderer();
      stlLoader = new THREE.STLLoader();
      requestAnimationFrame(tick);
    }

    function initCamera(){
      if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
        navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: "environment"  // This specifies the back camera
          } 
        })
        .then(function(stream){
          if("srcObject" in video){
            video.srcObject = stream;
          } else {
            video.src = window.URL.createObjectURL(stream);
          }
          video.play();
        })
        .catch(function(err){
          console.log("Camera error:", err);
        });
      }
    }

    function initRenderer(){
      // Calculate 16:9 dimensions that fit in viewport
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      const targetAspect = 16 / 9;
      const viewportAspect = viewportWidth / viewportHeight;
      
      let renderWidth, renderHeight;
      if (viewportAspect > targetAspect) {
          // Viewport wider than 16:9 - fit to height
          renderHeight = viewportHeight;
          renderWidth = Math.round(renderHeight * targetAspect);
      } else {
          // Viewport taller than 16:9 - fit to width  
          renderWidth = viewportWidth;
          renderHeight = Math.round(renderWidth / targetAspect);
      }
      
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setClearColor(0x000000, 1);
      renderer.setSize(renderWidth, renderHeight);
      
      const threeContainer = document.getElementById("threeContainer");
      threeContainer.appendChild(renderer.domElement);
      
      videoTexture = new THREE.Texture(video);
      videoTexture.minFilter = THREE.LinearFilter;
      
      backgroundScene = new THREE.Scene();
      backgroundCamera = new THREE.Camera();
      
      const plane = new THREE.Mesh(
          new THREE.PlaneGeometry(1.68, 2.4),
          new THREE.MeshBasicMaterial({ map: videoTexture, depthTest: false, depthWrite: false })
      );
      plane.material.side = THREE.DoubleSide;
      plane.position.z = -1;
      backgroundScene.add(backgroundCamera);
      backgroundScene.add(plane);
      
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(
          40,
          renderWidth / renderHeight, // This will be 16/9
          1,
          1000
      );
      scene.add(camera);
      
      const ambientLight = new THREE.AmbientLight(0x666666);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.7);
      directionalLight.position.set(0, 0, 1);
      scene.add(directionalLight);
      
      // Store dimensions for CV processing
      window.CV_RENDER_WIDTH = renderWidth;
      window.CV_RENDER_HEIGHT = renderHeight;
    }

    // Resize handler to maintain 16:9
    function handleResize() {
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const targetAspect = 16 / 9;
        const viewportAspect = viewportWidth / viewportHeight;
        
        let renderWidth, renderHeight;
        if (viewportAspect > targetAspect) {
            renderHeight = viewportHeight;
            renderWidth = Math.round(renderHeight * targetAspect);
        } else {
            renderWidth = viewportWidth;
            renderHeight = Math.round(renderWidth / targetAspect);
        }
        
        renderer.setSize(renderWidth, renderHeight);
        camera.aspect = renderWidth / renderHeight;
        camera.updateProjectionMatrix();
        
        window.CV_RENDER_WIDTH = renderWidth;
        window.CV_RENDER_HEIGHT = renderHeight;
    }

    window.addEventListener('resize', handleResize);

    function tick(){
      requestAnimationFrame(tick);
      if(video.readyState === video.HAVE_ENOUGH_DATA){
        try{
          context.drawImage(video,0,0,canvas.width,canvas.height);
          imageData = context.getImageData(0,0,canvas.width,canvas.height);
        } catch(e){ return; }

        if(videoTexture) videoTexture.needsUpdate = true;

        let markers = detector.detect(imageData);
        markers = processFilters(markers);

        updateScene(markers);

        renderer.autoClear = false;
        renderer.clear();
        renderer.render(backgroundScene, backgroundCamera);
        renderer.render(scene, camera);

        lastFrameMarkers = markers.slice();

        let overlay = document.getElementById("debugOverlay");
        if(overlay.classList.contains("visible")){
          drawDebugCanvas();
        }
      }
    }

    function processFilters(markers){
      let finalMarkers = markers.slice();
      if(useAdaptiveFilter){
        try {
          const processed = adaptiveFilter.process(imageData);
          const atf = detector.detect(processed);
          atf.forEach(m => {
            if(!markerExists(finalMarkers,m)) finalMarkers.push(m);
          });
        } catch(e){}
      }
      if(useMultiScale){
        try {
          const ms = multiScaleDetector.detect(imageData);
          ms.forEach(m => {
            if(!markerExists(finalMarkers,m)) finalMarkers.push(m);
          });
        } catch(e){}
      }
      if(useOpticalFlow){
        try {
          const ofm = opticalFlowTracker.track(imageData, finalMarkers);
          if(ofm && ofm.length>0) finalMarkers = ofm;
        } catch(e){}
      }
      return finalMarkers;
    }
    function markerExists(list, marker){
      return list.some(m => (m.id===marker.id && areMarkersClose(m,marker)));
    }
    function areMarkersClose(m1,m2){
      let c1={x:0,y:0}, c2={x:0,y:0};
      for(let i=0; i<4; i++){
        c1.x += m1.corners[i].x; c1.y += m1.corners[i].y;
        c2.x += m2.corners[i].x; c2.y += m2.corners[i].y;
      }
      c1.x/=4; c1.y/=4; c2.x/=4; c2.y/=4;
      let dx=c1.x-c2.x, dy=c1.y-c2.y;
      return (Math.sqrt(dx*dx+dy*dy)<20);
    }

    function updateScene(markers){
      while(scene.children.length>3){
        scene.remove(scene.children[3]);
      }
      const markerMap = {};
      markers.forEach(m => { markerMap[m.id] = m; });

      let visibleScenarioIDs = [];
      scenarios.forEach(s => {
        if(markerMap[s.identifierTag]) visibleScenarioIDs.push(s.identifierTag);
      });

      for(let sid in scenarioConfidence){
        if(visibleScenarioIDs.includes(parseInt(sid))) scenarioConfidence[sid]++;
        else scenarioConfidence[sid]=0;
      }

      let bestScenarioID=null, bestConfidence=0;
      for(let sid in scenarioConfidence){
        let val=scenarioConfidence[sid];
        if(val>=SCENARIO_CONFIDENCE_THRESHOLD && val>bestConfidence){
          bestConfidence=val; 
          bestScenarioID=parseInt(sid);
        }
      }
      if(bestScenarioID!==null){
        lastActiveIdentifierTag=bestScenarioID;
      }

      let activeScenario=null;
      if(lastActiveIdentifierTag!==null){
        activeScenario=scenarios.find(s=>s.identifierTag===lastActiveIdentifierTag);
      }

      // auto filter switching
      if(lastActiveIdentifierTag!==null){
        if(lastActiveIdentifierTag===0||lastActiveIdentifierTag===2){
          useAdaptiveFilter=true; useMultiScale=true; useOpticalFlow=true;
        } else if([1,3,4,5].includes(lastActiveIdentifierTag)){
          useAdaptiveFilter=true; useMultiScale=true; useOpticalFlow=false;
        }
      }

      if(activeScenario){
        activeScenario.objects.forEach(obj=>{
          if(markerMap[obj.tag]){
            placeObject(markerMap[obj.tag], obj.stl);
          }
        });
      }

      // Update side panel
      const kitNameEl = document.getElementById("arKitName");
      const kitDescEl = document.getElementById("arKitDesc");
      if(activeScenario && visibleScenarioIDs.includes(activeScenario.identifierTag)){
        kitNameEl.textContent = activeScenario.name;
        kitDescEl.textContent = activeScenario.desc;
      } else {
        kitNameEl.textContent = "No kits detected";
        kitDescEl.textContent = "Point your camera at a marker to see kit information";
      }
    }

    function placeObject(marker, stlRelativePath){
      let stlFullPath = "models/"+stlRelativePath;
      let corners=[];
      for(let i=0;i<marker.corners.length;i++){
        corners.push({
          x: marker.corners[i].x-(canvas.width/2),
          y: (canvas.height/2)-marker.corners[i].y
        });
      }
      let pose=posit.pose(corners);

      loadStl(stlFullPath,function(geometry){
        geometry.computeBoundingBox();
        let min=geometry.boundingBox.min, max=geometry.boundingBox.max;
        let center=new THREE.Vector3().addVectors(min,max).multiplyScalar(0.5);
        let offset=center.clone().multiplyScalar(-1);

        if(geometry.isBufferGeometry){
          geometry.translate(offset.x,offset.y,offset.z);
        } else {
          let mat=new THREE.Matrix4().makeTranslation(offset.x,offset.y,offset.z);
          geometry.applyMatrix(mat);
        }

        let material=new THREE.MeshPhongMaterial({color:0xD4A574});
        let mesh=new THREE.Mesh(geometry,material);

        let scaleFactor=0.05*modelSize*0.02;
        mesh.scale.set(scaleFactor,scaleFactor,scaleFactor);

        let r=pose.bestRotation;
        mesh.rotation.x=-Math.asin(-r[1][2]);
        mesh.rotation.y=-Math.atan2(r[0][2],r[2][2]);
        mesh.rotation.z=Math.atan2(r[1][0],r[1][1]);

        mesh.position.x=pose.bestTranslation[0];
        mesh.position.y=pose.bestTranslation[1];
        mesh.position.z=-pose.bestTranslation[2];

        scene.add(mesh);
      });
    }

    function loadStl(path,cb){
      if(stlCache[path]){
        cb(stlCache[path]);
        return;
      }
      stlLoader.load(path,function(geom){
        stlCache[path]=geom;cb(geom);
      });
    }

    /* DEBUG Overlay */
    function toggleDebugOverlay(){
      let overlay=document.getElementById("debugOverlay");
      overlay.classList.toggle("visible");
      if(overlay.classList.contains("visible")){
        canvas.style.display="block";
      } else {
        canvas.style.display="none";
      }
    }

    function drawDebugCanvas(){
      let dbgCanvas=document.getElementById("debugCanvas");
      let dbgCtx=dbgCanvas.getContext("2d");
      dbgCtx.clearRect(0,0,dbgCanvas.width,dbgCanvas.height);
      dbgCtx.drawImage(canvas,0,0);

      dbgCtx.strokeStyle="lime";
      dbgCtx.lineWidth=2;
      lastFrameMarkers.forEach(m=>{
        let c=m.corners;
        dbgCtx.beginPath();
        dbgCtx.moveTo(c[0].x,c[0].y);
        dbgCtx.lineTo(c[1].x,c[1].y);
        dbgCtx.lineTo(c[2].x,c[2].y);
        dbgCtx.lineTo(c[3].x,c[3].y);
        dbgCtx.closePath();
        dbgCtx.stroke();
      });

      let txt=(lastFrameMarkers.length===0)?"No markers detected.\n":"";
      lastFrameMarkers.forEach(m=>{
        txt+="Marker ID "+m.id+"\n";
      });
      document.getElementById("markerInfo").textContent=txt;
    }
  </script>
</body>
</html>
